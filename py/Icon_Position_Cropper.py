import torch
import numpy as np
from PIL import Image

class IconPositionCropper:
    """
    æ ¹æ®æŒ‡å®šçš„å››ä¸ªåæ ‡ç‚¹æ¥è£åˆ‡å›¾ç‰‡
    """
    
    def __init__(self):
        pass
        
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "å›¾ç‰‡": ("IMAGE",),
                "ä½ç½®æ•°æ®": ("DATA",),
                "èµ·å§‹åˆ—å·": ("INT", {
                    "default": 0,
                    "min": 0,
                    "max": 100,
                    "step": 1,
                }),
                "ç»ˆæ­¢åˆ—å·": ("INT", {
                    "default": 8,
                    "min": 0,
                    "max": 100,
                    "step": 1,
                }),
                "è¡Œå·": ("INT", {
                    "default": 8,
                    "min": 0,
                    "max": 100,
                    "step": 1,
                })
            }
        }

    RETURN_TYPES = ("IMAGE",)
    RETURN_NAMES = ("è£åˆ‡åå›¾åƒ",)
    FUNCTION = "crop_by_positions"
    CATEGORY = "ğŸŠ Kim-Nodes/ğŸ›‘Icon Processing | å›¾æ ‡å¤„ç†"

    def crop_by_positions(self, å›¾ç‰‡, ä½ç½®æ•°æ®, èµ·å§‹åˆ—å·, ç»ˆæ­¢åˆ—å·, è¡Œå·):
        # æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
        print("\n=== è¾“å…¥å‚æ•° ===")
        print(f"èµ·å§‹åˆ—å·: {èµ·å§‹åˆ—å·}")
        print(f"ç»ˆæ­¢åˆ—å·: {ç»ˆæ­¢åˆ—å·}")
        print(f"ç»“æŸè¡Œå·: {è¡Œå·}")
        print(f"è¾“å…¥å›¾ç‰‡æ‰¹æ¬¡å¤§å°: {å›¾ç‰‡.shape[0]}")
        
        # è°ƒè¯•è¾“å‡ºä½ç½®æ•°æ®æ ¼å¼
        if ä½ç½®æ•°æ® and len(ä½ç½®æ•°æ®) > 0:
            print("\n=== ä½ç½®æ•°æ®ç»“æ„ ===")
            print(f"ä½ç½®æ•°æ®ç±»å‹: {type(ä½ç½®æ•°æ®)}")
            print(f"ä½ç½®æ•°æ®é•¿åº¦: {len(ä½ç½®æ•°æ®)}")
            print(f"ç¬¬ä¸€ä¸ªå…ƒç´ é”®: {list(ä½ç½®æ•°æ®[0].keys()) if isinstance(ä½ç½®æ•°æ®[0], dict) else 'ä¸æ˜¯å­—å…¸'}")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰åµŒå¥—ç»“æ„
            if 'å›¾æ ‡ä½ç½®' in ä½ç½®æ•°æ®[0]:
                print(f"æ‰¾åˆ°å›¾æ ‡ä½ç½®å­—æ®µï¼ŒåŒ…å« {len(ä½ç½®æ•°æ®[0]['å›¾æ ‡ä½ç½®'])} ä¸ªä½ç½®é¡¹")
                if len(ä½ç½®æ•°æ®[0]['å›¾æ ‡ä½ç½®']) > 0:
                    å®é™…ä½ç½®æ•°æ® = ä½ç½®æ•°æ®[0]['å›¾æ ‡ä½ç½®']
                    print(f"å›¾æ ‡ä½ç½®é¡¹ç¤ºä¾‹: {å®é™…ä½ç½®æ•°æ®[0]}")
                    print(f"å›¾æ ‡ä½ç½®é¡¹é”®: {list(å®é™…ä½ç½®æ•°æ®[0].keys()) if isinstance(å®é™…ä½ç½®æ•°æ®[0], dict) else 'ä¸æ˜¯å­—å…¸'}")
            else:
                print("æœªæ‰¾åˆ°å›¾æ ‡ä½ç½®å­—æ®µ")
                å®é™…ä½ç½®æ•°æ® = ä½ç½®æ•°æ®
        else:
            print("è­¦å‘Š: ä½ç½®æ•°æ®ä¸ºç©º")
            raise ValueError("ä½ç½®æ•°æ®ä¸ºç©ºï¼Œæ— æ³•è¿›è¡Œè£åˆ‡")
        
        # å¤„ç†è¾“å…¥å›¾ç‰‡
        if not isinstance(å›¾ç‰‡, torch.Tensor):
            raise ValueError("å›¾ç‰‡å¿…é¡»æ˜¯ torch.Tensor ç±»å‹")

        # æ‰¾åˆ°å››ä¸ªè§’è½çš„ä¸­å¿ƒç‚¹
        å·¦ä¸Šä¸­å¿ƒç‚¹ = None
        å³ä¸Šä¸­å¿ƒç‚¹ = None
        å·¦ä¸‹ä¸­å¿ƒç‚¹ = None
        å³ä¸‹ä¸­å¿ƒç‚¹ = None
        
        # å¦‚æœæ•°æ®æ˜¯åµŒå¥—çš„ï¼Œä½¿ç”¨å›¾æ ‡ä½ç½®æ•°æ®
        if 'å›¾æ ‡ä½ç½®' in ä½ç½®æ•°æ®[0]:
            å®é™…ä½ç½®æ•°æ® = ä½ç½®æ•°æ®[0]['å›¾æ ‡ä½ç½®']
        else:
            å®é™…ä½ç½®æ•°æ® = ä½ç½®æ•°æ®
            
        print("\n=== æŸ¥æ‰¾å››ä¸ªè§’è½ç‚¹ ===")
        print(f"ä½¿ç”¨æ•°æ®é•¿åº¦: {len(å®é™…ä½ç½®æ•°æ®)}")
        print(f"æŸ¥æ‰¾èŒƒå›´: ç¬¬{èµ·å§‹åˆ—å·}åˆ—åˆ°ç¬¬{ç»ˆæ­¢åˆ—å·}åˆ—ï¼Œç¬¬0è¡Œåˆ°ç¬¬{è¡Œå·}è¡Œ")
        
        # éå†æ‰€æœ‰ä½ç½®æ‰¾åˆ°å››ä¸ªè§’è½
        for pos in å®é™…ä½ç½®æ•°æ®:
            try:
                if pos["åˆ—å·"] == èµ·å§‹åˆ—å· and pos["é‡å¤ç»„å·"] == 0:
                    center_x = pos["x"] + pos["å®½"]/2
                    center_y = pos["y"] + pos["é«˜"]/2
                    å·¦ä¸Šä¸­å¿ƒç‚¹ = (center_x, center_y)
                    print(f"æ‰¾åˆ°å·¦ä¸Šä¸­å¿ƒç‚¹: {å·¦ä¸Šä¸­å¿ƒç‚¹}")
                
                if pos["åˆ—å·"] == ç»ˆæ­¢åˆ—å· and pos["é‡å¤ç»„å·"] == 0:
                    center_x = pos["x"] + pos["å®½"]/2
                    center_y = pos["y"] + pos["é«˜"]/2
                    å³ä¸Šä¸­å¿ƒç‚¹ = (center_x, center_y)
                    print(f"æ‰¾åˆ°å³ä¸Šä¸­å¿ƒç‚¹: {å³ä¸Šä¸­å¿ƒç‚¹}")
                    
                if pos["åˆ—å·"] == èµ·å§‹åˆ—å· and pos["é‡å¤ç»„å·"] == è¡Œå·:
                    center_x = pos["x"] + pos["å®½"]/2
                    center_y = pos["y"] + pos["é«˜"]/2
                    å·¦ä¸‹ä¸­å¿ƒç‚¹ = (center_x, center_y)
                    print(f"æ‰¾åˆ°å·¦ä¸‹ä¸­å¿ƒç‚¹: {å·¦ä¸‹ä¸­å¿ƒç‚¹}")
                    
                if pos["åˆ—å·"] == ç»ˆæ­¢åˆ—å· and pos["é‡å¤ç»„å·"] == è¡Œå·:
                    center_x = pos["x"] + pos["å®½"]/2
                    center_y = pos["y"] + pos["é«˜"]/2
                    å³ä¸‹ä¸­å¿ƒç‚¹ = (center_x, center_y)
                    print(f"æ‰¾åˆ°å³ä¸‹ä¸­å¿ƒç‚¹: {å³ä¸‹ä¸­å¿ƒç‚¹}")
            except KeyError as e:
                print(f"è­¦å‘Šï¼šå¤„ç†ä½ç½®æ—¶å‡ºé”™ - é”®{e}ä¸å­˜åœ¨")
                continue
        
        if not all([å·¦ä¸Šä¸­å¿ƒç‚¹, å³ä¸Šä¸­å¿ƒç‚¹, å·¦ä¸‹ä¸­å¿ƒç‚¹, å³ä¸‹ä¸­å¿ƒç‚¹]):
            raise ValueError(f"æœªæ‰¾åˆ°æ‰€éœ€çš„å››ä¸ªè§’è½ç‚¹ï¼Œè¯·æ£€æŸ¥å‚æ•°æ˜¯å¦æ­£ç¡®ã€‚\n"
                          f"éœ€è¦çš„èŒƒå›´ï¼šç¬¬{èµ·å§‹åˆ—å·}åˆ—åˆ°ç¬¬{ç»ˆæ­¢åˆ—å·}åˆ—ï¼Œç¬¬0è¡Œåˆ°ç¬¬{è¡Œå·}è¡Œ")

        print(f"\n=== å››ä¸ªè§’è½çš„ä¸­å¿ƒç‚¹ä½ç½® ===")
        print(f"å·¦ä¸Šä¸­å¿ƒç‚¹: {å·¦ä¸Šä¸­å¿ƒç‚¹}")
        print(f"å³ä¸Šä¸­å¿ƒç‚¹: {å³ä¸Šä¸­å¿ƒç‚¹}")
        print(f"å·¦ä¸‹ä¸­å¿ƒç‚¹: {å·¦ä¸‹ä¸­å¿ƒç‚¹}")
        print(f"å³ä¸‹ä¸­å¿ƒç‚¹: {å³ä¸‹ä¸­å¿ƒç‚¹}")

        # è®¡ç®—è£åˆ‡åŒºåŸŸ
        left = int(min(å·¦ä¸Šä¸­å¿ƒç‚¹[0], å·¦ä¸‹ä¸­å¿ƒç‚¹[0]))
        right = int(max(å³ä¸Šä¸­å¿ƒç‚¹[0], å³ä¸‹ä¸­å¿ƒç‚¹[0]))
        top = int(min(å·¦ä¸Šä¸­å¿ƒç‚¹[1], å³ä¸Šä¸­å¿ƒç‚¹[1]))
        bottom = int(max(å·¦ä¸‹ä¸­å¿ƒç‚¹[1], å³ä¸‹ä¸­å¿ƒç‚¹[1]))

        print(f"\n=== æœ€ç»ˆè£åˆ‡åŒºåŸŸ ===")
        print(f"å·¦ä¸Šè§’: ({left}, {top})")
        print(f"å³ä¸‹è§’: ({right}, {bottom})")
        print(f"å®½åº¦: {right - left}, é«˜åº¦: {bottom - top}")

        # æ‰¹é‡å¤„ç†æ‰€æœ‰å›¾ç‰‡
        ç»“æœåˆ—è¡¨ = []
        æ‰¹æ¬¡å¤§å° = å›¾ç‰‡.shape[0]
        print(f"å¼€å§‹æ‰¹é‡å¤„ç† {æ‰¹æ¬¡å¤§å°} å¼ å›¾ç‰‡")
        
        for i in range(æ‰¹æ¬¡å¤§å°):
            å¤„ç†å›¾ç‰‡ = å›¾ç‰‡[i:i+1]  # è·å–å½“å‰å›¾ç‰‡
            
            if å¤„ç†å›¾ç‰‡.shape[1] in (3, 4):
                å¤„ç†å›¾ç‰‡ = å¤„ç†å›¾ç‰‡.permute(0, 2, 3, 1)
            
            image_np = (å¤„ç†å›¾ç‰‡[0].cpu().numpy() * 255).astype(np.uint8)
            image_pil = Image.fromarray(image_np)
            
            # è£åˆ‡å›¾ç‰‡
            cropped_image = image_pil.crop((left, top, right, bottom))
            
            # è½¬æ¢å› tensor
            result = np.array(cropped_image, dtype=np.float32) / 255.0
            if result.shape[-1] == 4:
                result = result[..., :3]  # å»æ‰ alpha é€šé“
            
            # è°ƒæ•´ç»´åº¦é¡ºåºä»¥ç¬¦åˆ IMAGE æ ¼å¼ [H, W, C]
            ç»“æœåˆ—è¡¨.append(torch.from_numpy(result))
        
        print(f"å·²å®Œæˆ {len(ç»“æœåˆ—è¡¨)} å¼ å›¾ç‰‡çš„è£åˆ‡å¤„ç†")
        # å°†åˆ—è¡¨è½¬æ¢æˆæ‰¹æ¬¡å¼ é‡ [B, H, W, C]
        return (torch.stack(ç»“æœåˆ—è¡¨),) 